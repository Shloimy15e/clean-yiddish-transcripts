<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yiddish Transcript Cleaner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group select,
        .input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: white;
        }

        .input-group select:focus,
        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-group select {
            cursor: pointer;
        }
        
        .profile-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.show {
            display: block;
        }

        .result-item {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .result-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-header h3 {
            color: #333;
            font-size: 18px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9ff;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .text-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .text-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .text-section-header {
            background: #f8f9fa;
            padding: 10px 15px;
            font-weight: 600;
            border-bottom: 1px solid #e0e0e0;
        }

        .text-content {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .removed-items {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .removed-items h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .removed-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .removed-item-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 5px;
        }

        .removed-item-examples {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            max-height: 100px;
            overflow-y: auto;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 4px;
            color: #c62828;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 4px;
            color: #2e7d32;
            margin-top: 20px;
        }
        
        .profile-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .text-sections {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî§ Yiddish Transcript Cleaner</h1>
            <p>Remove titles, headings, and notes from your transcripts</p>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" data-tab="upload">üìÑ Upload File</button>
                <button class="tab" data-tab="drive">üìÅ Google Drive</button>
            </div>

            <div id="upload-tab" class="tab-content active">
                <div class="input-group">
                    <label for="profileSelectUpload">üéØ Cleaning Profile</label>
                    <select id="profileSelectUpload" class="profile-select">
                        <!-- Options will be populated dynamically from the API -->
                    </select>
                    <div class="profile-info" id="profileInfoUpload" aria-live="polite">Loading profile descriptions...</div>
                </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop your Word document here</h3>
                    <p>or click to browse</p>
                    <input type="file" id="fileInput" accept=".doc,.docx" style="display: none;">
                </div>
                <button class="btn btn-primary" id="processBtn" disabled>Process Document</button>
            </div>

            <div id="drive-tab" class="tab-content">
                <div class="input-group">
                    <label for="profileSelectDrive">üéØ Cleaning Profile</label>
                    <select id="profileSelectDrive" class="profile-select">
                        <!-- Options will be populated dynamically from the API -->
                    </select>
                    <div class="profile-info" id="profileInfoDrive" aria-live="polite">Loading profile descriptions...</div>
                </div>
                <div class="input-group">
                    <label for="driveUrl">Google Drive Folder URL</label>
                    <input type="text" id="driveUrl" placeholder="https://drive.google.com/drive/folders/..." />
                </div>
                <button class="btn btn-primary" id="processDriveBtn">Process Drive Folder</button>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    <strong>Note:</strong> Google Drive integration requires additional setup. See README for instructions.
                </p>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your documents...</p>
            </div>

            <div class="error" id="error"></div>

            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        // Store profile descriptions
        let profileDescriptions = {};
        let profileOptions = [];

        // Load profiles on page load
        async function loadProfiles() {
            try {
                const response = await fetch('/profiles');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                profileDescriptions = await response.json();
                
                // Build profile options array (sorted for consistency)
                const profileKeys = Object.keys(profileDescriptions).sort();
                profileOptions = profileKeys.map(key => ({
                    value: key,
                    label: formatProfileName(key),
                    description: profileDescriptions[key]
                }));
                
                // Populate dropdown menus
                populateDropdowns();
                
                // Update initial description
                updateProfileInfo();
            } catch (error) {
                console.error('Failed to load profiles from API:', error.message || error);
                // Provide fallback message to user
                const uploadInfo = document.getElementById('profileInfoUpload');
                const driveInfo = document.getElementById('profileInfoDrive');
                if (uploadInfo) uploadInfo.textContent = 'Unable to load profiles. Please refresh the page.';
                if (driveInfo) driveInfo.textContent = 'Unable to load profiles. Please refresh the page.';
            }
        }
        
        // Populate both dropdown menus with profiles from API
        function populateDropdowns() {
            const uploadSelect = document.getElementById('profileSelectUpload');
            const driveSelect = document.getElementById('profileSelectDrive');
            
            // Default profile to select (most comprehensive)
            const defaultProfile = 'titles_and_parentheses';
            
            [uploadSelect, driveSelect].forEach(select => {
                if (select) {
                    // Clear existing options
                    select.innerHTML = '';
                    
                    // Add profile options
                    profileOptions.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.value;
                        option.textContent = profile.label;
                        // Select the default profile
                        if (profile.value === defaultProfile) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Format profile key to display name
        function formatProfileName(key) {
            return key.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        // Get profile display name from key
        function getProfileDisplayName(profileKey) {
            if (!profileKey) return 'Unknown';
            const option = profileOptions.find(opt => opt.value === profileKey);
            return option ? option.label : formatProfileName(profileKey);
        }

        // Update profile info text when selection changes
        function updateProfileInfo() {
            const uploadSelect = document.getElementById('profileSelectUpload');
            const driveSelect = document.getElementById('profileSelectDrive');
            const uploadInfo = document.getElementById('profileInfoUpload');
            const driveInfo = document.getElementById('profileInfoDrive');
            
            if (uploadSelect && uploadInfo) {
                const selectedProfile = uploadSelect.value;
                uploadInfo.textContent = profileDescriptions[selectedProfile] || '';
            }
            
            if (driveSelect && driveInfo) {
                const selectedProfile = driveSelect.value;
                driveInfo.textContent = profileDescriptions[selectedProfile] || '';
            }
        }

        // Add event listeners for profile selection changes
        document.addEventListener('DOMContentLoaded', () => {
            // Load profiles first
            loadProfiles().then(() => {
                // Then attach event listeners after profiles are loaded
                const uploadSelect = document.getElementById('profileSelectUpload');
                const driveSelect = document.getElementById('profileSelectDrive');
                
                if (uploadSelect) {
                    uploadSelect.addEventListener('change', updateProfileInfo);
                }
                if (driveSelect) {
                    driveSelect.addEventListener('change', updateProfileInfo);
                }
            });
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
                
                // Clear results and errors
                document.getElementById('results').classList.remove('show');
                document.getElementById('error').classList.remove('show');
            });
        });

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        let selectedFile = null;

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                selectedFile = file;
                uploadArea.querySelector('h3').textContent = file.name;
                uploadArea.querySelector('p').textContent = 'Click to choose another file';
                processBtn.disabled = false;
            } else {
                showError('Please select a Word document (.doc or .docx)');
            }
        }

        // Process single file
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('profile', document.getElementById('profileSelectUpload').value);

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayResults([data]);
                } else {
                    showError(data.error || 'An error occurred');
                }
            } catch (error) {
                showError('Failed to process document: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // Process Drive folder
        document.getElementById('processDriveBtn').addEventListener('click', async () => {
            const driveUrl = document.getElementById('driveUrl').value.trim();
            const profile = document.getElementById('profileSelectDrive').value;

            if (!driveUrl) {
                showError('Please enter a Google Drive folder URL');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/process-drive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ drive_url: driveUrl, profile: profile })
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.results);
                } else {
                    showError(data.error || 'An error occurred');
                }
            } catch (error) {
                showError('Failed to process Drive folder: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            // Store cleaned texts for download functionality
            window.cleanedTexts = {};

            results.forEach((result, index) => {
                if (!result.success) {
                    resultsDiv.innerHTML += `
                        <div class="error show">
                            <strong>Error processing ${result.filename}:</strong> ${result.error}
                        </div>
                    `;
                    return;
                }
                
                // Store cleaned text for download
                window.cleanedTexts[index] = result.cleaned_text;

                const stats = result.statistics;
                const profileName = result.profile || 'unknown';
                const profileDisplay = getProfileDisplayName(profileName);
                
                const resultHtml = `
                    <div class="result-item">
                        <div class="result-header">
                            <h3>
                                ${escapeHtml(result.filename)}
                                <span class="profile-badge">${profileDisplay}</span>
                            </h3>
                            <button class="btn btn-secondary download-btn" data-filename="${escapeHtml(result.filename)}" data-text-index="${index}">
                                ‚¨áÔ∏è Download Cleaned
                            </button>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value">${stats.reduction_percentage}%</div>
                                <div class="stat-label">Reduced</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${stats.removed_words}</div>
                                <div class="stat-label">Words Removed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${stats.removed_lines}</div>
                                <div class="stat-label">Lines Removed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${stats.cleaned_words}</div>
                                <div class="stat-label">Words Remaining</div>
                            </div>
                        </div>

                        <div class="text-sections">
                            <div class="text-section">
                                <div class="text-section-header">Original Text (Preview)</div>
                                <div class="text-content">${escapeHtml(result.original_text.substring(0, 1000))}${result.original_text.length > 1000 ? '...' : ''}</div>
                            </div>
                            <div class="text-section">
                                <div class="text-section-header">Cleaned Text</div>
                                <div class="text-content">${escapeHtml(result.cleaned_text)}</div>
                            </div>
                        </div>

                        ${result.removed_items.length > 0 ? `
                            <div class="removed-items">
                                <h4>üóëÔ∏è Removed Content</h4>
                                ${result.removed_items.map(item => `
                                    <div class="removed-item">
                                        <div class="removed-item-title">
                                            ${item.pattern} (${item.count} occurrence${item.count > 1 ? 's' : ''})
                                        </div>
                                        <div class="removed-item-examples">
                                            Examples: ${item.matches.slice(0, 3).map(m => escapeHtml(m)).join(', ')}
                                            ${item.count > 3 ? '...' : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                resultsDiv.innerHTML += resultHtml;
            });

            resultsDiv.classList.add('show');
            
            // Add event listeners for download buttons
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filename = this.getAttribute('data-filename');
                    const textIndex = this.getAttribute('data-text-index');
                    const cleanedText = window.cleanedTexts[textIndex];
                    downloadCleaned(filename, cleanedText);
                });
            });
        }

        async function downloadCleaned(filename, cleanedText) {
            try {
                const response = await fetch('/download-cleaned', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: filename,
                        cleaned_text: cleanedText
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename.replace(/\.[^/.]+$/, '') + '_cleaned.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (error) {
                showError('Failed to download cleaned document: ' + error.message);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function hideError() {
            document.getElementById('error').classList.remove('show');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function unescapeHtml(text) {
            const div = document.createElement('div');
            div.innerHTML = text;
            return div.textContent || div.innerText || '';
        }
    </script>
</body>
</html>
