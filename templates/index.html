<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yiddish Transcript Cleaner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'spin-slow': 'spin 1.5s linear infinite',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseSoft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
        }
        .icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }
        @keyframes copied-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .copied-animation {
            animation: copied-pulse 0.3s ease-out;
        }
        .removed-text {
            background-color: #fecaca;
            text-decoration: line-through;
            text-decoration-color: #dc2626;
            color: #991b1b;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Custom checkbox styling */
        .processor-item {
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .processor-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .processor-item .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.875rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
            color: #374151;
        }
        .processor-item:hover .checkbox-label {
            border-color: #93c5fd;
            background: #f0f9ff;
        }
        .processor-item input[type="checkbox"]:checked + .checkbox-label {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1d4ed8;
        }
        .processor-item input[type="checkbox"]:focus + .checkbox-label {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .processor-item .checkmark {
            width: 1.125rem;
            height: 1.125rem;
            border: 2px solid #d1d5db;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .processor-item input[type="checkbox"]:checked + .checkbox-label .checkmark {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        .processor-item .checkmark svg {
            width: 0.75rem;
            height: 0.75rem;
            stroke: white;
            stroke-width: 3;
            opacity: 0;
            transform: scale(0);
            transition: all 0.15s ease;
        }
        .processor-item input[type="checkbox"]:checked + .checkbox-label .checkmark svg {
            opacity: 1;
            transform: scale(1);
        }

        /* Glass morphism card */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        
        /* Tab styling */
        .tab-btn {
            position: relative;
            transition: all 0.2s ease;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            border-radius: 3px 3px 0 0;
            transition: all 0.2s ease;
        }
        .tab-btn.active::after {
            background: #3b82f6;
        }
        
        /* Upload area improvements */
        .upload-zone {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transition: all 0.3s ease;
        }
        .upload-zone:hover {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.2);
        }
        .upload-zone.drag-over {
            background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
            border-color: #2563eb;
            transform: scale(1.02);
        }
        
        /* Button improvements */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }
        
        /* Result card animations */
        .result-card {
            animation: slideUp 0.4s ease-out;
        }
        
        /* Stats card hover */
        .stat-item {
            transition: all 0.2s ease;
        }
        .stat-item:hover {
            transform: translateY(-2px);
        }
        
        /* Scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Background pattern */
        .bg-pattern {
            background-color: #2563eb;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.05) 0%, transparent 50%);
        }
    </style>
</head>
<body class="bg-pattern min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
    <!-- SVG Icon Definitions -->
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
        <symbol id="icon-language" viewBox="0 0 640 512">
            <path d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3 0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1 .1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2L179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4c.9 .6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9l-18.9-11.3c-4.5-2.7-8.8-5.5-13.1-8.5c-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8l-12.2-12.2c-7.8-7.8-7.8-20.5 0-28.3s20.5-7.8 28.3 0l14.6 14.6 .5 .5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/>
        </symbol>
        <symbol id="icon-upload" viewBox="0 0 384 512">
            <path d="M214.6 41.4c-12.5-12.5-32.8-12.5-45.3 0l-160 160c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 141.2V448c0 17.7 14.3 32 32 32s32-14.3 32-32V141.2L329.4 246.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-160-160z"/>
        </symbol>
        <symbol id="icon-drive" viewBox="0 0 512 512">
            <path d="M339 314.9L175.4 32h161.2l163.6 282.9H339zm-137.5 23.6L120.9 480h310.5L512 338.5H201.5zM154.1 67.4L0 338.5 80.6 480 237 208.8 154.1 67.4z"/>
        </symbol>
        <symbol id="icon-sliders" viewBox="0 0 512 512">
            <path d="M0 416c0 17.7 14.3 32 32 32l54.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 448c17.7 0 32-14.3 32-32s-14.3-32-32-32l-246.7 0c-12.3-28.3-40.5-48-73.3-48s-61 19.7-73.3 48L32 384c-17.7 0-32 14.3-32 32zm128 0a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM320 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm32-80c-32.8 0-61 19.7-73.3 48L32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l246.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48l54.7 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-54.7 0c-12.3-28.3-40.5-48-73.3-48zM192 128a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm73.3-64C253 35.7 224.8 16 192 16s-61 19.7-73.3 48L32 64C14.3 64 0 78.3 0 96s14.3 32 32 32l86.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 128c17.7 0 32-14.3 32-32s-14.3-32-32-32L265.3 64z"/>
        </symbol>
        <symbol id="icon-cloud-upload" viewBox="0 0 640 512">
            <path d="M144 480C64.5 480 0 415.5 0 336c0-62.8 40.2-116.2 96.2-135.9c-.1-2.7-.2-5.4-.2-8.1c0-88.4 71.6-160 160-160c59.3 0 111 32.2 138.7 80.2C409.9 102 428.3 96 448 96c53 0 96 43 96 96c0 12.2-2.3 23.8-6.4 34.6C596 238.4 640 290.1 640 352c0 70.7-57.3 128-128 128H144zm79-217c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l39-39V392c0 13.3 10.7 24 24 24s24-10.7 24-24V257.9l39 39c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0l-80 80z"/>
        </symbol>
        <symbol id="icon-copy" viewBox="0 0 448 512">
            <path d="M208 0H332.1c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9V336c0 26.5-21.5 48-48 48H208c-26.5 0-48-21.5-48-48V48c0-26.5 21.5-48 48-48zM48 128h80v64H64V448H256V416h64v48c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V176c0-26.5 21.5-48 48-48z"/>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 512 512">
            <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H346.5l-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 448 512">
            <path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/>
        </symbol>
        <symbol id="icon-check" viewBox="0 0 448 512">
            <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
        </symbol>
        <symbol id="icon-sparkles" viewBox="0 0 512 512">
            <path d="M327.5 85.2c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L384 128l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L448 128l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L448 64 426.8 7.5C425.1 3 420.8 0 416 0s-9.1 3-10.8 7.5L384 64 327.5 85.2zM205.1 73.3c-2.6-5.7-8.3-9.3-14.5-9.3s-11.9 3.6-14.5 9.3L145.6 136 73.3 166.6c-5.7 2.6-9.3 8.3-9.3 14.5s3.6 11.9 9.3 14.5l72.3 30.5 30.6 72.3c2.6 5.7 8.3 9.3 14.5 9.3s11.9-3.6 14.5-9.3l30.6-72.3 72.3-30.6c5.7-2.6 9.3-8.3 9.3-14.5s-3.6-11.9-9.3-14.5L235.7 136 205.1 73.3zM384 384l-56.5 21.2c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L384 448l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L448 448l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L448 384l-21.2-56.5c-1.7-4.5-6-7.5-10.8-7.5s-9.1 3-10.8 7.5L384 384z"/>
        </symbol>
    </svg>
    
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="text-center text-white mb-8 sm:mb-12">
            <div class="inline-flex items-center justify-center gap-3 mb-4">
                <div class="p-3 bg-white/20 rounded-2xl backdrop-blur-sm">
                    <span class="icon text-4xl"><svg><use href="#icon-language"/></svg></span>
                </div>
            </div>
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-3 tracking-tight">
                Yiddish Transcript Cleaner
            </h1>
            <p class="text-base sm:text-lg text-blue-100 max-w-md mx-auto">
                Remove titles, headings, and notes from your transcripts with ease
            </p>
        </header>

        <!-- Main Card -->
        <div class="glass-card rounded-2xl sm:rounded-3xl p-6 sm:p-8 lg:p-10 mb-6">
            <!-- Tabs -->
            <div class="flex gap-1 mb-8 border-b-2 border-gray-100 -mx-2">
                <button class="tab-btn active px-4 sm:px-6 py-3 text-gray-500 font-medium flex items-center gap-2 transition-all hover:text-blue-600 rounded-t-lg" data-tab="upload">
                    <span class="icon text-lg"><svg><use href="#icon-upload"/></svg></span>
                    <span class="hidden sm:inline">Upload File</span>
                    <span class="sm:hidden">Upload</span>
                </button>
                <button class="tab-btn px-4 sm:px-6 py-3 text-gray-500 font-medium flex items-center gap-2 transition-all hover:text-blue-600 rounded-t-lg" data-tab="drive">
                    <span class="icon text-lg"><svg><use href="#icon-drive"/></svg></span>
                    <span class="hidden sm:inline">Google Drive</span>
                    <span class="sm:hidden">Drive</span>
                </button>
            </div>

            <!-- Upload Tab -->
            <div id="upload-tab" class="tab-content">
                <!-- Profile Selector -->
                <div class="mb-6">
                    <label class="flex items-center gap-2 mb-3 font-semibold text-gray-800">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <span>Cleaning Profile</span>
                    </label>
                    <div class="flex flex-wrap gap-2" id="profileSelectorUpload">
                        <!-- Profile buttons will be generated by JS -->
                    </div>
                </div>

                <!-- Processor Selection -->
                <div class="mb-6">
                    <label class="flex items-center gap-2 mb-3 font-semibold text-gray-800">
                        <span class="icon text-blue-600"><svg><use href="#icon-sliders"/></svg></span>
                        <span>Processing Plugins</span>
                        <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full" id="selectedCountUpload">0 selected</span>
                    </label>
                    <div id="processorCheckboxesUpload" class="flex flex-wrap gap-2 sm:gap-3 p-4 border-2 border-gray-100 rounded-xl bg-gradient-to-br from-gray-50 to-white">
                        <div class="flex items-center gap-2 text-sm text-gray-500 animate-pulse">
                            <div class="w-4 h-4 border-2 border-gray-300 rounded-full border-t-blue-500 spinner"></div>
                            <span>Loading processors...</span>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-3 text-sm">
                        <button type="button" onclick="selectAllProcessors('Upload')" class="text-blue-600 hover:text-blue-800 font-medium transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Select All
                        </button>
                        <span class="text-gray-300">|</span>
                        <button type="button" onclick="deselectAllProcessors('Upload')" class="text-gray-500 hover:text-gray-700 font-medium transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Upload Area -->
                <div id="uploadArea" class="upload-zone border-3 border-dashed border-blue-300 rounded-2xl p-8 sm:p-12 text-center cursor-pointer mb-6">
                    <div class="text-6xl text-blue-500 mb-4">
                        <span class="icon"><svg><use href="#icon-cloud-upload"/></svg></span>
                    </div>
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-2">Drop your Word document here</h3>
                    <p class="text-gray-500 mb-4">or click to browse your files</p>
                    <p class="text-xs text-gray-400">Supports .doc and .docx files</p>
                    <input type="file" id="fileInput" accept=".doc,.docx" class="hidden">
                </div>

                <!-- Process Button -->
                <button class="btn-primary w-full sm:w-auto px-8 py-3.5 text-white rounded-xl font-semibold text-base disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2" id="processBtn" disabled>
                    <span class="icon"><svg><use href="#icon-sparkles"/></svg></span>
                    <span>Process Document</span>
                </button>
            </div>

            <!-- Drive Tab -->
            <div id="drive-tab" class="tab-content hidden">
                <!-- Profile Selector -->
                <div class="mb-6">
                    <label class="flex items-center gap-2 mb-3 font-semibold text-gray-800">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <span>Cleaning Profile</span>
                    </label>
                    <div class="flex flex-wrap gap-2" id="profileSelectorDrive">
                        <!-- Profile buttons will be generated by JS -->
                    </div>
                </div>

                <!-- Processor Selection -->
                <div class="mb-6">
                    <label class="flex items-center gap-2 mb-3 font-semibold text-gray-800">
                        <span class="icon text-blue-600"><svg><use href="#icon-sliders"/></svg></span>
                        <span>Processing Plugins</span>
                        <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full" id="selectedCountDrive">0 selected</span>
                    </label>
                    <div id="processorCheckboxesDrive" class="flex flex-wrap gap-2 sm:gap-3 p-4 border-2 border-gray-100 rounded-xl bg-gradient-to-br from-gray-50 to-white">
                        <div class="flex items-center gap-2 text-sm text-gray-500 animate-pulse">
                            <div class="w-4 h-4 border-2 border-gray-300 rounded-full border-t-blue-500 spinner"></div>
                            <span>Loading processors...</span>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-3 text-sm">
                        <button type="button" onclick="selectAllProcessors('Drive')" class="text-blue-600 hover:text-blue-800 font-medium transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Select All
                        </button>
                        <span class="text-gray-300">|</span>
                        <button type="button" onclick="deselectAllProcessors('Drive')" class="text-gray-500 hover:text-gray-700 font-medium transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Drive URL Input -->
                <div class="mb-6">
                    <label for="driveUrl" class="block mb-2 font-semibold text-gray-800">Google Drive Folder URL</label>
                    <input type="text" id="driveUrl" placeholder="https://drive.google.com/drive/folders/..." 
                           class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                </div>

                <!-- Process Button -->
                <button class="btn-primary w-full sm:w-auto px-8 py-3.5 text-white rounded-xl font-semibold text-base flex items-center justify-center gap-2" id="processDriveBtn">
                    <span class="icon"><svg><use href="#icon-sparkles"/></svg></span>
                    <span>Process Drive Folder</span>
                </button>

                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                    <p class="text-amber-800 text-sm flex items-start gap-2">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span><strong>Note:</strong> Google Drive integration requires additional setup. See README for instructions.</span>
                    </p>
                </div>
            </div>

            <!-- Loading State -->
            <div class="hidden text-center py-16" id="loading">
                <div class="relative inline-block">
                    <div class="w-16 h-16 border-4 border-blue-100 rounded-full"></div>
                    <div class="w-16 h-16 border-4 border-transparent border-t-blue-600 rounded-full spinner absolute top-0 left-0"></div>
                </div>
                <p class="text-gray-600 mt-6 font-medium">Processing your documents...</p>
                <p class="text-gray-400 text-sm mt-2">This may take a moment</p>
            </div>

            <!-- Error State -->
            <div class="hidden bg-red-50 border border-red-200 rounded-xl p-4 mt-6" id="error">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-red-700" id="errorText"></p>
                </div>
            </div>

            <!-- Results -->
            <div class="hidden mt-8" id="results"></div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-blue-200 text-sm pb-4">
            <p>Made with care for Yiddish document processing</p>
        </footer>
    </div>

    <script>
        let availableProcessors = {};
        let availableFormats = {};

        // Default processors to check
        // Note: brackets_inline replaces regex for smarter bracket handling
        // Note: parentheses_notes is NOT included by default since most parens are spoken
        const defaultProcessors = ['special_chars', 'seif_marker', 'title_style', 'brackets_inline', 'whitespace'];
        
        // Processor grouping for better UI organization
        const processorGroups = {
            'Text Cleanup': ['special_chars', 'whitespace'],
            'Titles & Headings': ['title_style', 'seif_marker'],
            'Non-Speech Notes': ['brackets_inline', 'parentheses_notes', 'editorial_hebrew', 'force_remove'],
        };
        
        // Cleaning profiles - preset combinations of processors
        const CLEANING_PROFILES = {
            'custom': {
                name: 'Custom',
                description: 'Select processors manually',
                processors: null  // null means don't change selection
            },
            '5710-5711': {
                name: '5710-5711 Transcripts',
                description: 'Basic cleaning without bracket removal',
                processors: ['special_chars', 'seif_marker', 'title_style', 'whitespace', 'force_remove']
            },
            '5712+': {
                name: '5712+ Transcripts',
                description: 'Standard cleaning with inline brackets removed',
                processors: ['special_chars', 'seif_marker', 'title_style', 'brackets_inline', 'whitespace', 'force_remove']
            },
            'with-editorial': {
                name: 'With Editorial Removal',
                description: 'Includes editorial Hebrew detection (citations, references)',
                processors: ['special_chars', 'seif_marker', 'title_style', 'brackets_inline', 'editorial_hebrew', 'whitespace']
            },
            'heavy': {
                name: 'Heavy Cleaning',
                description: 'All processors including parentheses and force remove',
                processors: ['special_chars', 'seif_marker', 'title_style', 'brackets_inline', 'parentheses_notes', 'editorial_hebrew', 'force_remove', 'whitespace']
            },
            'minimal': {
                name: 'Minimal',
                description: 'Only basic text cleanup',
                processors: ['special_chars', 'whitespace']
            }
        };

        // Track current selected profile per tab
        let currentProfile = {
            'Upload': '5712+',
            'Drive': '5712+'
        };

        function populateProfileSelector(suffix) {
            const container = document.getElementById('profileSelector' + suffix);
            if (!container) return;
            
            container.innerHTML = '';
            
            for (const [key, profile] of Object.entries(CLEANING_PROFILES)) {
                const isActive = currentProfile[suffix] === key;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `profile-btn px-4 py-2 rounded-lg text-sm font-medium transition-all border-2 ${
                    isActive 
                        ? 'bg-blue-600 text-white border-blue-600 shadow-md' 
                        : 'bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50'
                }`;
                btn.dataset.profile = key;
                btn.dataset.suffix = suffix;
                btn.textContent = profile.name;
                
                // Add tooltip with description
                if (profile.description) {
                    tippy(btn, {
                        content: profile.description,
                        placement: 'top',
                        arrow: true,
                        theme: 'light-border',
                        animation: 'fade',
                        delay: [300, 0],
                    });
                }
                
                btn.addEventListener('click', () => selectProfile(key, suffix));
                container.appendChild(btn);
            }
        }
        
        function selectProfile(profileKey, suffix) {
            const profile = CLEANING_PROFILES[profileKey];
            if (!profile) return;
            
            currentProfile[suffix] = profileKey;
            
            // Update button styles
            const container = document.getElementById('profileSelector' + suffix);
            container.querySelectorAll('.profile-btn').forEach(btn => {
                const isActive = btn.dataset.profile === profileKey;
                btn.className = `profile-btn px-4 py-2 rounded-lg text-sm font-medium transition-all border-2 ${
                    isActive 
                        ? 'bg-blue-600 text-white border-blue-600 shadow-md' 
                        : 'bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50'
                }`;
            });
            
            // If profile has processors defined, update checkboxes
            if (profile.processors !== null) {
                // Uncheck all first
                document.querySelectorAll(`input[name="processors-${suffix}"]`).forEach(cb => {
                    cb.checked = false;
                });
                
                // Check the profile's processors
                profile.processors.forEach(processorName => {
                    const checkbox = document.querySelector(`input[name="processors-${suffix}"][value="${processorName}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
                updateSelectedCount(suffix);
                updateAllGroupCheckboxes(suffix);
            }
        }
        
        function onProcessorManualChange(suffix) {
            // When user manually changes a processor, switch to "custom" profile
            if (currentProfile[suffix] !== 'custom') {
                currentProfile[suffix] = 'custom';
                
                // Update button styles
                const container = document.getElementById('profileSelector' + suffix);
                if (container) {
                    container.querySelectorAll('.profile-btn').forEach(btn => {
                        const isActive = btn.dataset.profile === 'custom';
                        btn.className = `profile-btn px-4 py-2 rounded-lg text-sm font-medium transition-all border-2 ${
                            isActive 
                                ? 'bg-blue-600 text-white border-blue-600 shadow-md' 
                                : 'bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50'
                        }`;
                    });
                }
            }
        }

        async function loadProcessors() {
            try {
                const response = await fetch('/processors');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                availableProcessors = await response.json();
                populateProcessorCheckboxes('Upload');
                populateProcessorCheckboxes('Drive');
                populateProfileSelector('Upload');
                populateProfileSelector('Drive');
                // Apply default profile
                selectProfile('5712+', 'Upload');
                selectProfile('5712+', 'Drive');
            } catch (error) {
                console.error('Failed to load processors:', error.message || error);
                const errorHtml = `
                    <div class="flex items-center gap-2 text-sm text-red-500">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <span>Unable to load processors. Please refresh the page.</span>
                    </div>
                `;
                document.getElementById('processorCheckboxesUpload').innerHTML = errorHtml;
                document.getElementById('processorCheckboxesDrive').innerHTML = errorHtml;
            }
        }
        
        function populateProcessorCheckboxes(suffix) {
            const container = document.getElementById('processorCheckboxes' + suffix);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Track which processors we've added
            const addedProcessors = new Set();
            
            // Add processors by group
            for (const [groupName, processorNames] of Object.entries(processorGroups)) {
                // Check if any processor in this group exists
                const existingInGroup = processorNames.filter(name => availableProcessors[name]);
                if (existingInGroup.length === 0) continue;
                
                // Create group wrapper
                const groupWrapper = document.createElement('div');
                groupWrapper.className = 'w-full mb-4';
                
                // Create group header with checkbox
                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex items-center gap-2 mb-2';
                
                const groupId = groupName.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + suffix;
                groupHeader.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="${groupId}" class="group-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" data-group="${groupName}" data-suffix="${suffix}">
                        <span class="text-sm font-semibold text-gray-700 group-hover:text-blue-600 transition-colors">${groupName}</span>
                    </label>
                `;
                
                // Handle group checkbox change
                const groupCheckbox = groupHeader.querySelector('.group-checkbox');
                groupCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const groupProcessors = groupWrapper.querySelectorAll(`input[name="processors-${suffix}"]`);
                    groupProcessors.forEach(cb => cb.checked = isChecked);
                    updateSelectedCount(suffix);
                    onProcessorManualChange(suffix);
                });
                
                groupWrapper.appendChild(groupHeader);
                
                // Create group container for processors
                const groupContainer = document.createElement('div');
                groupContainer.className = 'flex flex-wrap gap-2 w-full pl-6';
                
                for (const name of processorNames) {
                    const info = availableProcessors[name];
                    if (!info) continue;
                    
                    addedProcessors.add(name);
                    const isDefault = defaultProcessors.includes(name);
                    
                    const wrapper = document.createElement('label');
                    wrapper.className = 'processor-item';
                    
                    wrapper.innerHTML = `
                        <input type="checkbox" name="processors-${suffix}" value="${name}" data-group="${groupName}" ${isDefault ? 'checked' : ''}>
                        <span class="checkbox-label">
                            <span class="checkmark">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                            <span>${formatProcessorName(name)}</span>
                        </span>
                    `;
                    
                    const checkbox = wrapper.querySelector('input');
                    checkbox.addEventListener('change', () => {
                        updateSelectedCount(suffix);
                        updateGroupCheckbox(groupName, suffix);
                        onProcessorManualChange(suffix);
                    });
                    
                    // Add tippy tooltip with description from backend
                    if (info.description) {
                        const label = wrapper.querySelector('.checkbox-label');
                        tippy(label, {
                            content: info.description,
                            placement: 'top',
                            arrow: true,
                            theme: 'light-border',
                            animation: 'fade',
                            delay: [200, 0],
                        });
                    }
                    
                    groupContainer.appendChild(wrapper);
                }
                
                groupWrapper.appendChild(groupContainer);
                container.appendChild(groupWrapper);
                
                // Update group checkbox initial state
                updateGroupCheckbox(groupName, suffix);
            }
            
            // Add any remaining processors that weren't in a group
            const ungroupedProcessors = Object.keys(availableProcessors).filter(name => !addedProcessors.has(name));
            if (ungroupedProcessors.length > 0) {
                const groupWrapper = document.createElement('div');
                groupWrapper.className = 'w-full mb-4';
                
                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex items-center gap-2 mb-2';
                
                const groupId = 'other_' + suffix;
                groupHeader.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="${groupId}" class="group-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" data-group="Other" data-suffix="${suffix}">
                        <span class="text-sm font-semibold text-gray-700 group-hover:text-blue-600 transition-colors">Other</span>
                    </label>
                `;
                
                const groupCheckbox = groupHeader.querySelector('.group-checkbox');
                groupCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const groupProcessors = groupWrapper.querySelectorAll(`input[name="processors-${suffix}"]`);
                    groupProcessors.forEach(cb => cb.checked = isChecked);
                    updateSelectedCount(suffix);
                    onProcessorManualChange(suffix);
                });
                
                groupWrapper.appendChild(groupHeader);
                
                const groupContainer = document.createElement('div');
                groupContainer.className = 'flex flex-wrap gap-2 w-full pl-6';
                
                for (const name of ungroupedProcessors) {
                    const info = availableProcessors[name];
                    const isDefault = defaultProcessors.includes(name);
                    
                    const wrapper = document.createElement('label');
                    wrapper.className = 'processor-item';
                    
                    wrapper.innerHTML = `
                        <input type="checkbox" name="processors-${suffix}" value="${name}" data-group="Other" ${isDefault ? 'checked' : ''}>
                        <span class="checkbox-label">
                            <span class="checkmark">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </span>
                            <span>${formatProcessorName(name)}</span>
                        </span>
                    `;
                    
                    const checkbox = wrapper.querySelector('input');
                    checkbox.addEventListener('change', () => {
                        updateSelectedCount(suffix);
                        updateGroupCheckbox('Other', suffix);
                        onProcessorManualChange(suffix);
                    });
                    
                    // Add tippy tooltip with description from backend
                    if (info.description) {
                        const label = wrapper.querySelector('.checkbox-label');
                        tippy(label, {
                            content: info.description,
                            placement: 'top',
                            arrow: true,
                            theme: 'light-border',
                            animation: 'fade',
                            delay: [200, 0],
                        });
                    }
                    
                    groupContainer.appendChild(wrapper);
                }
                
                groupWrapper.appendChild(groupContainer);
                container.appendChild(groupWrapper);
                
                // Update group checkbox initial state
                updateGroupCheckbox('Other', suffix);
            }
            
            updateSelectedCount(suffix);
        }
        
        function updateGroupCheckbox(groupName, suffix) {
            const groupId = groupName.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + suffix;
            const groupCheckbox = document.getElementById(groupId);
            if (!groupCheckbox) return;
            
            const groupProcessors = document.querySelectorAll(`input[name="processors-${suffix}"][data-group="${groupName}"]`);
            const checkedCount = Array.from(groupProcessors).filter(cb => cb.checked).length;
            
            if (checkedCount === 0) {
                groupCheckbox.checked = false;
                groupCheckbox.indeterminate = false;
            } else if (checkedCount === groupProcessors.length) {
                groupCheckbox.checked = true;
                groupCheckbox.indeterminate = false;
            } else {
                groupCheckbox.checked = false;
                groupCheckbox.indeterminate = true;
            }
        }
        
        function updateSelectedCount(suffix) {
            const count = document.querySelectorAll(`input[name="processors-${suffix}"]:checked`).length;
            const total = document.querySelectorAll(`input[name="processors-${suffix}"]`).length;
            const countEl = document.getElementById('selectedCount' + suffix);
            if (countEl) {
                countEl.textContent = `${count} of ${total} selected`;
            }
        }
        
        function formatProcessorName(name) {
            return name.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function getSelectedProcessors(suffix) {
            const checkboxes = document.querySelectorAll(`input[name="processors-${suffix}"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function selectAllProcessors(suffix) {
            document.querySelectorAll(`input[name="processors-${suffix}"]`).forEach(cb => cb.checked = true);
            updateSelectedCount(suffix);
            updateAllGroupCheckboxes(suffix);
            onProcessorManualChange(suffix);
        }
        
        function deselectAllProcessors(suffix) {
            document.querySelectorAll(`input[name="processors-${suffix}"]`).forEach(cb => cb.checked = false);
            updateSelectedCount(suffix);
            updateAllGroupCheckboxes(suffix);
            onProcessorManualChange(suffix);
        }
        
        function updateAllGroupCheckboxes(suffix) {
            // Update all group checkboxes for this suffix
            const allGroups = [...Object.keys(processorGroups), 'Other'];
            allGroups.forEach(groupName => updateGroupCheckbox(groupName, suffix));
        }

        async function loadFormats() {
            try {
                const response = await fetch('/formats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                availableFormats = await response.json();
                console.log('Loaded formats:', availableFormats);
            } catch (error) {
                console.error('Failed to load formats:', error.message || error);
                // Default formats if API fails
                availableFormats = {
                    'docx': { name: 'docx', title: 'Word Document', extension: '.docx' },
                    'txt': { name: 'txt', title: 'Plain Text', extension: '.txt' }
                };
            }
        }

        // Load on page start
        loadProcessors();
        loadFormats();

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(t => {
                    t.classList.remove('active', 'text-blue-600', 'font-semibold');
                    t.classList.add('text-gray-500');
                });
                tab.classList.add('active', 'text-blue-600', 'font-semibold');
                tab.classList.remove('text-gray-500');
                
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(tab.dataset.tab + '-tab').classList.remove('hidden');
            });
        });

        // File upload
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        let selectedFiles = [];

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(f => 
                f.name.endsWith('.doc') || f.name.endsWith('.docx')
            );
            if (selectedFiles.length > 0) {
                const fileNames = selectedFiles.map(f => f.name).join(', ');
                uploadArea.innerHTML = `
                    <div class="text-5xl text-emerald-500 mb-4">
                        <svg class="inline-block w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${selectedFiles.length} file(s) selected</h3>
                    <p class="text-gray-500 text-sm">${fileNames}</p>
                    <p class="text-blue-600 text-sm mt-3 font-medium">Click to change selection</p>
                `;
                processBtn.disabled = false;
            }
        }

        processBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;
            
            hideError();
            showLoading(true);
            
            try {
                const formData = new FormData();
                formData.append('file', selectedFiles[0]);
                
                // Get selected processors
                const processors = getSelectedProcessors('Upload');
                formData.append('processors', JSON.stringify(processors));

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const results = await response.json();
                displayResults(results);
            } catch (error) {
                showError('Failed to process files: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // Drive processing
        document.getElementById('processDriveBtn').addEventListener('click', async () => {
            const driveUrl = document.getElementById('driveUrl').value;
            if (!driveUrl) {
                showError('Please enter a Google Drive file or folder URL');
                return;
            }

            hideError();
            showLoading(true);

            try {
                const processors = getSelectedProcessors('Drive');
                const response = await fetch('/process-drive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        folder_url: driveUrl,
                        processors: processors
                    })
                });

                const results = await response.json();
                displayResults(results);
            } catch (error) {
                showError('Failed to process Drive folder: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            window.cleanedTexts = {};
            window.originalTexts = {};
            window.removedItems = {};

            // Normalize to array if single result
            if (!Array.isArray(results)) {
                results = [results];
            }

            results.forEach((result, index) => {
                if (!result.success) {
                    resultsDiv.innerHTML += `
                        <div class="result-card bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <p class="font-semibold text-red-700">${escapeHtml(result.filename)}</p>
                                    <p class="text-red-600 text-sm mt-1">${result.error}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                window.cleanedTexts[index] = result.cleaned_text;
                window.originalTexts[index] = result.original_text;
                window.removedItems[index] = result.removed_items;

                const stats = result.statistics;
                const processorsUsed = result.processors || [];
                
                // Build format checkboxes for this result
                let formatCheckboxes = '';
                for (const [key, format] of Object.entries(availableFormats)) {
                    const checked = key === 'docx' ? 'checked' : '';
                    formatCheckboxes += `
                        <label class="flex items-center gap-2 cursor-pointer text-sm group">
                            <input type="checkbox" class="format-checkbox-${index} w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 focus:ring-2" 
                                   value="${key}" ${checked}>
                            <span class="text-gray-600 group-hover:text-gray-800 transition-colors">${format.title || key.toUpperCase()}</span>
                        </label>
                    `;
                }
                
                const resultHtml = `
                    <div class="result-card border border-gray-200 rounded-2xl overflow-hidden mb-6 shadow-sm hover:shadow-md transition-shadow">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-gray-50 to-white px-5 py-4 border-b border-gray-100">
                            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800">
                                        ${escapeHtml(result.filename)}
                                    </h3>
                                </div>
                                <div class="flex flex-wrap items-center gap-4">
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm text-gray-500 font-medium">Format:</span>
                                        ${formatCheckboxes}
                                    </div>
                                    <button class="download-btn px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-lg font-medium transition-all hover:from-emerald-600 hover:to-emerald-700 hover:shadow-lg flex items-center gap-2" data-filename="${escapeHtml(result.filename)}" data-text-index="${index}">
                                        <span class="icon"><svg><use href="#icon-download"/></svg></span> Download
                                    </button>
                                </div>
                            </div>
                            <!-- Processor Tags -->
                            <div class="flex flex-wrap gap-1.5 mt-4">
                                ${processorsUsed.map(p => `
                                    <span class="inline-flex items-center bg-blue-50 text-blue-700 px-2.5 py-1 rounded-lg text-xs font-medium border border-blue-100">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                        ${formatProcessorName(p)}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 p-5 bg-gradient-to-br from-blue-50 to-indigo-50">
                            <div class="stat-item text-center p-3 bg-white/60 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold text-blue-600">${stats.reduction_percentage}%</div>
                                <div class="text-xs text-gray-500 mt-1 font-medium">Reduced</div>
                            </div>
                            <div class="stat-item text-center p-3 bg-white/60 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold text-rose-500">${stats.removed_words}</div>
                                <div class="text-xs text-gray-500 mt-1 font-medium">Words Removed</div>
                            </div>
                            <div class="stat-item text-center p-3 bg-white/60 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold text-amber-500">${stats.removed_lines}</div>
                                <div class="text-xs text-gray-500 mt-1 font-medium">Lines Removed</div>
                            </div>
                            <div class="stat-item text-center p-3 bg-white/60 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold text-emerald-500">${stats.cleaned_words}</div>
                                <div class="text-xs text-gray-500 mt-1 font-medium">Words Remaining</div>
                            </div>
                        </div>

                        <!-- Text Preview -->
                        <div class="p-5">
                            <div class="border border-gray-200 rounded-xl overflow-hidden">
                                <div class="bg-gray-50 px-4 py-3 font-semibold border-b border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                                    <span class="text-gray-700">Original Text <span class="text-gray-400 font-normal text-sm">(with removals highlighted)</span></span>
                                    <div class="flex gap-2">
                                        <button class="copy-btn px-3 py-1.5 bg-gray-600 text-white rounded-lg text-sm font-medium transition-all hover:bg-gray-700 flex items-center gap-1.5" onclick="copyToClipboard(${index}, 'original', this)">
                                            <span class="icon"><svg><use href="#icon-copy"/></svg></span> Copy Original
                                        </button>
                                        <button class="copy-btn px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium transition-all hover:bg-blue-700 flex items-center gap-1.5" onclick="copyToClipboard(${index}, 'cleaned', this)">
                                            <span class="icon"><svg><use href="#icon-copy"/></svg></span> Copy Cleaned
                                        </button>
                                    </div>
                                </div>
                                <div dir="rtl" class="p-4 max-h-96 overflow-y-auto text-sm leading-relaxed whitespace-pre-wrap break-words text-gray-700 custom-scrollbar bg-white">${highlightRemovedText(result.original_text, result.removed_items)}</div>
                            </div>
                        </div>
                    </div>
                `;
                resultsDiv.innerHTML += resultHtml;
            });

            resultsDiv.classList.remove('hidden');
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Initialize Tippy tooltips on removed text
            tippy('.removed-text[data-tippy-content]', {
                placement: 'top',
                arrow: true,
                theme: 'light-border',
                animation: 'fade',
                delay: [200, 0],
            });
            
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filename = this.getAttribute('data-filename');
                    const textIndex = this.getAttribute('data-text-index');
                    const cleanedText = window.cleanedTexts[textIndex];
                    downloadCleaned(filename, cleanedText, textIndex);
                });
            });
        }

        async function downloadCleaned(filename, cleanedText, textIndex) {
            // Get selected formats for this result
            const checkboxes = document.querySelectorAll(`.format-checkbox-${textIndex}:checked`);
            let formats = Array.from(checkboxes).map(cb => cb.value);
            
            if (formats.length === 0) {
                formats = ['docx']; // Default
            }
            
            // Download each format
            for (const format of formats) {
                try {
                    const formatInfo = availableFormats[format] || { extension: '.' + format };
                    const response = await fetch('/download-cleaned', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filename: filename,
                            cleaned_text: cleanedText,
                            format: format
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const baseName = filename.replace(/\.[^/.]+$/, '');
                        a.download = `${baseName}_cleaned${formatInfo.extension || '.' + format}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        // Small delay between downloads
                        if (formats.length > 1) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    } else {
                        const error = await response.json();
                        showError(`Failed to download ${format}: ${error.error}`);
                    }
                } catch (error) {
                    showError(`Failed to download ${format}: ${error.message}`);
                }
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            document.getElementById('upload-tab').classList.toggle('hidden', show);
            document.getElementById('drive-tab').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            document.getElementById('errorText').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightRemovedText(originalText, removedItems) {
            if (!removedItems || removedItems.length === 0) {
                return escapeHtml(originalText);
            }
            
            // Collect all positions from removed items
            let positions = [];
            removedItems.forEach(item => {
                // Use positions if available (preferred method)
                if (item.positions && item.positions.length > 0) {
                    item.positions.forEach(pos => {
                        positions.push({
                            start: pos.start,
                            end: pos.end,
                            reason: pos.reason || item.pattern
                        });
                    });
                }
                // Fallback to pattern matching for items without positions
                else if (item.matches && item.matches.length > 0) {
                    item.matches.forEach(match => {
                        let startIndex = 0;
                        let index;
                        while ((index = originalText.indexOf(match, startIndex)) !== -1) {
                            positions.push({
                                start: index,
                                end: index + match.length,
                                reason: item.pattern
                            });
                            startIndex = index + 1;
                        }
                    });
                }
            });
            
            if (positions.length === 0) {
                return escapeHtml(originalText);
            }
            
            // Sort by start position
            positions.sort((a, b) => a.start - b.start);
            
            // Merge overlapping ranges, combining reasons
            let merged = [];
            positions.forEach(pos => {
                if (merged.length === 0) {
                    merged.push({...pos});
                } else {
                    const last = merged[merged.length - 1];
                    if (pos.start <= last.end) {
                        last.end = Math.max(last.end, pos.end);
                        // Combine reasons if different
                        if (last.reason !== pos.reason && !last.reason.includes(pos.reason)) {
                            last.reason = last.reason + ', ' + pos.reason;
                        }
                    } else {
                        merged.push({...pos});
                    }
                }
            });
            
            // Build the highlighted HTML
            let result = '';
            let lastEnd = 0;
            merged.forEach(pos => {
                // Add text before the removed section
                if (pos.start > lastEnd) {
                    result += escapeHtml(originalText.substring(lastEnd, pos.start));
                }
                // Add the removed section with highlighting and tooltip
                const removedText = originalText.substring(pos.start, pos.end);
                const escapedReason = escapeHtml(pos.reason);
                result += `<span class="removed-text" data-tippy-content="${escapedReason}">${escapeHtml(removedText)}</span>`;
                lastEnd = pos.end;
            });
            // Add any remaining text
            if (lastEnd < originalText.length) {
                result += escapeHtml(originalText.substring(lastEnd));
            }
            
            return result;
        }

        async function copyToClipboard(index, type, button) {
            try {
                const text = type === 'cleaned' ? window.cleanedTexts[index] : window.originalTexts[index];
                if (!text) {
                    console.error('Text not found for index:', index, 'type:', type);
                    showError('Text not available for copying');
                    return;
                }
                
                await navigator.clipboard.writeText(text);
                
                const originalHTML = button.innerHTML;
                const originalClasses = button.className;
                button.innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span> Copied!';
                button.className = button.className.replace(/bg-\w+-600/g, 'bg-emerald-500').replace(/hover:bg-\w+-700/g, 'hover:bg-emerald-600');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.className = originalClasses;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                showError('Failed to copy to clipboard');
            }
        }
    </script>
</body>
</html>
